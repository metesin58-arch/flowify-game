workflows:
  ios-release:
    name: iOS Release Build
    instance_type: mac_mini_m2
    max_build_duration: 60
    integrations:
      app_store_connect: Zeal
    environment:
      xcode: latest
      cocoapods: default
      vars:
        BUNDLE_ID: "com.metestudios.flowify"
        XCODE_SCHEME: "App"
        TEAM_ID: "ERUH5NNQUB" 
    scripts:
      - name: Install dependencies
        script: npm install
      
      - name: Build web assets
        script: npm run build
      
      - name: Capacitor Sync & Assets
        script: |
          npm run assets:generate
          npx cap add ios || true
          npx cap sync ios
      
      - name: Install CocoaPods
        script: cd ios/App && pod install
      
      - name: Build and Sign iOS Application
        script: |
          keychain initialize
          
          echo "--- 1. Apple Portali / UI Sertifika Baglantisi ---"
          # UI'a dosya yuklediysen onlari sisteme kurar
          keychain add-certificates || echo "UI sertifikasi bulunamadı, devam ediliyor..."
          
          # API (Zeal) üzerinden profilleri indir/yarat
          xcode-project use-profiles --create --bundle-id "$BUNDLE_ID"
          
          # Profili dosyadan bul ve degiskenlere ata
          PROV_PATH=$(find "$HOME/Library/MobileDevice/Provisioning Profiles" -name "*.mobileprovision" | head -n 1)
          
          if [ -z "$PROV_PATH" ]; then
            echo "HATA: Provisioning Profile bulunamadı! Lütfen Apple Developer Portal veya Codemagic UI tarafını kontrol et."
            exit 1
          fi
          
          PROV_NAME=$(/usr/libexec/PlistBuddy -c "Print :Name" /dev/stdin <<< $(security cms -D -i "$PROV_PATH"))
          PROV_UUID=$(grep -aA1 "UUID" "$PROV_PATH" | grep -o "[0-9a-fA-F-]\{36\}")
          
          echo "Kullanılacak Profil: $PROV_NAME ($PROV_UUID)"
          
          echo "--- 2. Xcode Projesini Ayarlama ---"
          cd ios/App
          # Proje dosyasına Team ve Manuel imzalama zorlaması yapıyoruz
          sed -i '' "s/DEVELOPMENT_TEAM = [^;]*;/DEVELOPMENT_TEAM = $TEAM_ID;/g" App.xcodeproj/project.pbxproj
          sed -i '' "s/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g" App.xcodeproj/project.pbxproj
          
          echo "--- 3. Arşivleme (Build) Başlıyor ---"
          xcodebuild -workspace App.xcworkspace \
            -scheme "$XCODE_SCHEME" \
            -configuration Release \
            -archivePath build/App.xcarchive \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            PROVISIONING_PROFILE="$PROV_UUID" \
            PROVISIONING_PROFILE_SPECIFIER="$PROV_NAME" \
            archive
          
          echo "--- 4. IPA Export ---"
          cat <<EOF > export_options.plist
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0"><dict>
            <key>method</key><string>app-store</string>
            <key>teamID</key><string>$TEAM_ID</string>
            <key>provisioningProfiles</key><dict><key>$BUNDLE_ID</key><string>$PROV_NAME</string></dict>
            <key>signingStyle</key><string>manual</string>
          </dict></plist>
          EOF
          
          xcodebuild -exportArchive \
            -archivePath build/App.xcarchive \
            -exportOptionsPlist export_options.plist \
            -exportPath build/ios/ipa
    
    artifacts:
      - ios/App/build/ios/ipa/*.ipa
    
    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
